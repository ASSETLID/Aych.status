#!/usr/bin/python

import os, sys
lib_path = os.path.abspath(os.path.join('..'))
sys.path.append(lib_path)

from bottle import Bottle, run
from bottle import get, post, request, response, static_file
import json
import base64
import git
import uuid
import tempfile
import owsdiff
from jinja2 import Environment, FileSystemLoader, FileSystemBytecodeCache

import pprint
pp = pprint.PrettyPrinter(indent=4)

TEMPLATES="/home/ows/ows"
bcc = FileSystemBytecodeCache('/tmp/jinja_cache', '%s.cache')
j2_env = Environment(loader=FileSystemLoader(TEMPLATES),trim_blocks=True,bytecode_cache=bcc,cache_size=100)
BASEURL="http://ows.irill.org"

app = application = Bottle()

@app.get('/compare/form')
def form():
    template = j2_env.get_template('templates/compare/form.html')
    output = template.render({'baseurl' : BASEURL})
    return output

@app.post('/compare/submit')
def submit():
    commit1 = None
    commit2 = None
    patch = None
    diff = []
    if 'commit1' in request.forms :
        commit1 = request.forms.get('commit1')
    if 'commit2' in request.forms :
        commit2 = request.forms.get('commit2')
    if 'patch' in request.forms :
        patch = request.files.get('patch')
    print "diff %s %s %s" % (commit1,commit2,patch)
    pp.pprint(request.forms.items())

    if patch :
        (fid,patchfile) = tempfile.mkstemp('ows-wsgi')
        with open(patchfile, 'w') as open_file:
            open_file.write(patch.file.read())
        open_file.close()
        diff = owsdiff.patch(commit1,patchfile)
        os.remove(patchfile)
    elif commit2 :
        diff = owsdiff.run(commit1,commit2)
 
    template = j2_env.get_template('templates/compare/modal.html')
    output = template.render({'report' : diff, 'commit1' : commit1, 'commit2' : commit2, 'baseurl' : BASEURL})
    return output

@app.post('/compare/api')
def jsondiff():
    commit1 = None
    commit2 = None
    patch = None
    diff = []
    if 'commit1' in request.json :
        commit1 = request.json['commit1']
    if 'commit2' in request.json :
        commit2 = request.json['commit2']
    if 'patch' in request.json :
        patch = request.json['patch']

    if patch :
        (fid,patchfile) = tempfile.mkstemp('ows-wsgi')
        with open(patchfile, 'w') as open_file:
            open_file.write(base64.b64decode(patch))
        open_file.close()
        diff = owsdiff.patch(commit1,patchfile)
        os.remove(patchfile)
    elif commit2 :
        diff = owsdiff.run(commit1,commit2)

    print diff

    response.content_type = 'application/json'
    return json.dumps(diff)

class StripPathMiddleware(object):
    '''
    Get that slash out of the request
    '''
    def __init__(self, a):
        self.a = a
    def __call__(self, e, h):
        e['PATH_INFO'] = e['PATH_INFO'].rstrip('/')
        return self.a(e, h)

if __name__ == '__main__':
    run(app=StripPathMiddleware(app),
        server='python_server',
        host='0.0.0.0',
        port=8080)
